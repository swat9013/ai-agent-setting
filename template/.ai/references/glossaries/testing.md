# テスト用語集（Khorikov基準）

## 良いテストの4本柱

| 柱 | 説明 |
|---|---|
| 退行に対する保護 | バグを検出する能力。テストが実行するコード量に比例 |
| リファクタリング耐性 | 実装変更時に偽陽性を出さない。**最重要** |
| 迅速なフィードバック | テスト実行が速い |
| 保守性 | テストの理解・変更が容易 |

## 観察可能な振る舞い vs 実装詳細

| 種類 | 説明 | 検証すべきか |
|-----|------|------------|
| 観察可能な振る舞い | 公開API、最終出力、外部から見える副作用 | ✅ |
| 実装詳細 | privateメソッド、内部状態、呼び出し順序 | ❌ |

**判定基準**: クライアントの目標達成に直接貢献するか？

## テストダブル

| 種類 | 役割 | 検証してよいか |
|-----|------|--------------|
| Mock | 外向きの相互作用を模倣（副作用を起こす呼び出し） | ✅ |
| Stub | 内向きの相互作用を模倣（データ取得） | ❌ |
| Spy | 手書きのMock | ✅ |
| Dummy | シグネチャを満たすだけの値 | - |
| Fake | 簡易実装（インメモリDB等） | - |

**CQS原則との対応**:
- Command（副作用あり、void戻り） → Mock
- Query（副作用なし、値を返す） → Stub

## 依存の種類

| 種類 | 例 | テストでの扱い |
|-----|-----|--------------|
| 管理された依存 | アプリケーションDB | 実インスタンス使用 |
| 管理されていない依存 | SMTP、外部API、メッセージバス | Mock使用 |

**境界の原則**: 内部クラス間の通信はMock検証しない

## テストスタイル（優先順）

1. **出力ベース**: 純粋関数の戻り値を検証 ← 最も脆くない
2. **状態ベース**: 操作後の状態を検証
3. **コミュニケーションベース**: 相互作用を検証 ← 最も脆い

## アンチパターン

| パターン | 問題 |
|---------|------|
| 構造検査 | 内部構造の存在確認。リファクタリングで壊れる |
| Stub検証 | `verify(stub)` は実装詳細への結合 |
| 過剰なMock | 内部コラボレータをすべてMock |
| カバレッジ目標 | 高カバレッジは品質を保証しない |
