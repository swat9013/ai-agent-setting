---
type: command
name: code-review
description: コードレビューを実行し、優先度別フィードバックを提供する
usage:
  - /code-review path/to/file.ts
  - /code-review src/features/
  - /code-review feature/branch-name
  - /code-review
---
# Code Review Command

コードレビューを実行し、優先度別フィードバックを提供する。

## 使用方法

```bash
/code-review path/to/file.ts       # 特定ファイル
/code-review src/features/         # ディレクトリ
/code-review feature/branch-name   # 特定ブランチと main/master との差分
/code-review                       # 引数なし（下記参照）
```

引数なしの場合:
- main/master 以外 → 現在のブランチと main/master との差分
- main/master → ステージング済み・未ステージングの変更

## 前提条件

以下を確認してから実行。満たさない場合は中止し理由を報告:

1. レビュー対象のファイルが存在する
2. `.ai/context.md` が読み込み可能
3. `.ai/references/checklists/code-review.md` が存在する

## 実行手順

### 1. 対象特定
- 引数がファイル/ディレクトリ → そのパスを対象
- 引数がブランチ名 → main/master との差分を取得
- 引数なし → 現在のブランチを判定し上記ルールに従う

### 2. ドメイン知識収集
- context.md の制約・クリティカル領域を確認
- docs/ からドメイン知識を収集（存在する場合）
- 重要ドメイン（決済、認証等）を特定

### 3. 自動チェック実行
- テスト、Lint、ビルドを実行
- **失敗時は修正を促し、レビューを中止**
- 通過後にレビュー開始

### 4. レビュー実行
- `.ai/references/checklists/code-review.md` を読み込む
- Critical → High → Medium → Low の順でチェック
- 結合度・コナーセンスの観点でモジュール間依存を評価
- MR説明の背景情報（調査結果、実行計画等）を活用し、設計判断の妥当性を評価
- 一般的パターンからの逸脱は選択肢を提示（現状維持推奨でも却下案を明記）
- 重要ドメインは厳格チェック（下記参照）

### 5. 結果出力
- 下記の出力形式に従って報告

## 出力形式

```markdown
# コードレビュー結果: [対象]

## Critical
### 1. `file.ts:42` - [問題の簡潔な説明]

**問題**: [具体的な問題点]

**修正案**:
| 選択肢 | 推奨度 | 概要 | 理由 |
|--------|--------|------|------|
| A | ⭐⭐⭐ | [修正案A] | [なぜこれが最も推奨されるか] |
| B | ⭐⭐ | [修正案B] | [利点と欠点] |
| C | ⭐ | [修正案C] | [限定的な状況で有効な理由] |

## High / Medium / Low
（同様の形式）

## 総評
指摘: Critical X, High X, Medium X, Low X
次のアクション: [推奨事項]
```

### 推奨度の基準

| 推奨度 | 意味 |
|--------|------|
| ⭐⭐⭐ | 強く推奨: 最もシンプルで保守性が高い |
| ⭐⭐ | 推奨: 状況によっては最適解 |
| ⭐ | 条件付き: 特定の制約下でのみ有効 |

## 成功基準

このコマンドの実行は以下を満たしたとき成功とみなす:

1. 問題点が優先度別（Critical/High/Medium/Low）に整理されている
2. 各指摘に具体的な修正案と根拠が含まれている
3. 自動チェック（テスト、Lint、ビルド）が通過している

## 重要ドメイン特別ルール

context.md や docs/ で定義された重要ドメイン配下のコードには以下を厳格に適用:

- **冪等性**: 同じリクエストを2回送っても安全
- **トランザクション管理**: 複数更新はアトミック
- **高テストカバレッジ**: 重要ロジックは全パターン網羅
- **エラーハンドリング**: タイムアウト、ネットワークエラー等を明示的に処理

## 完了チェックリスト

結果報告前に以下をすべて確認。未達成項目があれば修正してから報告:

- [ ] 前提条件をすべて満たした
- [ ] 自動チェック（テスト、Lint、ビルド）を実行した
- [ ] チェックリストの全項目を確認した
- [ ] 各指摘に具体的な修正案と根拠を記載した
- [ ] 優先度（Critical/High/Medium/Low）が適切
- [ ] 出力形式に従っている

## 原則

- 優先順位を明確に、具体的な修正案と根拠を提示
- 曖昧な指摘、主観の押し付け、Lint自動化可能な指摘は避ける

## 関連

- `/review-update` - レビューの学びをチェックリスト・コマンドに反映
