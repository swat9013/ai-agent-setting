---
type: command
name: code-review
description: コードレビューを実行し、優先度別フィードバックを提供する
usage:
  - /code-review path/to/file.ts
  - /code-review src/features/
  - /code-review feature/branch-name
  - /code-review
---
# Code Review Command

コードレビューを実行し、優先度別フィードバックを提供する。

## 使用方法

```bash
/code-review path/to/file.ts       # 特定ファイル
/code-review src/features/         # ディレクトリ
/code-review feature/branch-name   # 特定ブランチと main/master との差分
/code-review                       # 引数なし（下記参照）
```

引数なしの場合:
- main/master 以外 → 現在のブランチと main/master との差分
- main/master → ステージング済み・未ステージングの変更

## 前提条件

以下を確認してから実行。満たさない場合は中止し理由を報告:

1. レビュー対象のファイルが存在する
2. `.ai/context.md` が読み込み可能
3. `.ai/references/checklists/code-review.md` が存在する

## 実行手順

### 1. 対象特定と規模判定
- 引数がファイル/ディレクトリ → そのパスを対象
- 引数がブランチ名 → main/master との差分を取得
- 引数なし → 現在のブランチを判定し上記ルールに従う
- **規模判定**:
  - 変更ファイル数と総変更行数を確認
  - 大規模変更（50ファイル超 or 1000行超）の場合:
    - ユーザーに通知し、Critical/High のみ先行レビューを提案
    - 承諾時: Critical/High → 結果報告 → Medium/Low は別途実施
    - 拒否時: 全項目を一括レビュー（時間がかかる旨を警告）

### 2. ドメイン知識収集
- context.md の制約・クリティカル領域を確認
- docs/ からドメイン知識を収集（存在する場合）
- 重要ドメイン（決済、認証等）を特定

### 3. 自動チェック実行
- テスト、Lint、ビルドを実行
- **失敗時は修正を促し、レビューを中止**
- 通過後にレビュー開始

### 4. レビュー実行
- `.ai/references/checklists/code-review.md` を読み込む
- チェックリスト内の「→ 用語定義:」リンク先も評価基準として参照
- Critical → High → Medium → Low の順でチェック
- MR説明の背景情報（調査結果、実行計画等）を活用し、設計判断の妥当性を評価
- 一般的パターンからの逸脱は選択肢を提示（現状維持推奨でも却下案を明記）
- 重要ドメインは厳格チェック（下記参照）

### 5. 自己検証（Self-Reflection）

レビュー結果を出力する前に、各指摘を以下の観点で再検証。
不正確なものは除外し、スコアを調整:

1. **位置検証**: 指摘した `ファイル:行番号` に該当コードが存在するか
   - 存在しない → 除外（確信度0）

2. **構文検証**: 修正案を適用した場合、構文エラーにならないか
   - エラーになる → 修正案を修正、または除外

3. **コンテキスト整合**: 修正案が周辺コード・既存実装と矛盾しないか
   - 矛盾する → 確信度を下げる（-2〜3）

4. **重複排除**: 同一問題への複数指摘がないか
   - 重複あり → 最も適切な1つに統合

5. **過剰指摘フィルタ**: 以下に該当する指摘は除外
   - Lint/Formatter で自動修正可能なもの
   - 単なるスタイル好みの押し付け
   - 明確な根拠なく「〜すべき」と主張するもの

### 6. 結果出力
- 下記の出力形式に従って報告

## 出力形式

```markdown
# コードレビュー結果: [対象]

## Critical
### 1. `file.ts:42` - [問題の簡潔な説明] (確信度: 9/10)

**問題**: [具体的な問題点]
**根拠**: [なぜこれが問題と判断したか - コードの具体的な箇所を引用]

**修正案**:
| 選択肢 | 概要 | 理由 |
|--------|------|------|
| A (推奨) | [修正案A] | [なぜこれが最も推奨されるか] |
| B | [修正案B] | [利点と欠点] |

## High / Medium / Low
（同様の形式）

## 総評
指摘: Critical X, High X, Medium X, Low X
次のアクション: [推奨事項]
```

### 必須フィールド

各指摘には以下を必ず含める:

| フィールド | 説明 |
|-----------|------|
| ファイル:行番号 | 正確な位置（存在確認済み） |
| 問題 | 何が問題か（1-2文） |
| 確信度 | 1-10のスコア |
| 根拠 | なぜ問題と判断したか（コード引用必須） |
| 修正案テーブル | 選択肢・概要・理由（推奨は選択肢名に明記） |

### 確信度の基準

| スコア | 意味 | 例 |
|--------|------|-----|
| 9-10 | 明確な問題 | バグ、セキュリティ脆弱性、データ損失リスク |
| 7-8 | 高確度で問題 | N+1クエリ、未処理例外、境界値漏れ |
| 5-6 | 改善推奨 | 可読性低下、責務混在、テスト不足 |
| 3-4 | 提案レベル | 命名改善、リファクタリング候補 |
| 1-2 | 参考情報 | 別解の紹介、将来の検討事項 |

**注意**: 確信度5以下は「議論の余地あり」を意味する。レビュイーが意図的な選択であれば却下可能。

## 成功基準

このコマンドの実行は以下を満たしたとき成功とみなす:

1. 問題点が優先度別（Critical/High/Medium/Low）に整理されている
2. 各指摘に確信度スコア・根拠・具体的な修正案が含まれている
3. 自動チェック（テスト、Lint、ビルド）が通過している
4. 自己検証（Self-Reflection）を実施し、不正確な指摘を除外済み

## 重要ドメイン特別ルール

context.md や docs/ で定義された重要ドメイン配下のコードには以下を厳格に適用:

- **冪等性**: 同じリクエストを2回送っても安全
- **トランザクション管理**: 複数更新はアトミック
- **高テストカバレッジ**: 重要ロジックは全パターン網羅
- **エラーハンドリング**: タイムアウト、ネットワークエラー等を明示的に処理

## 完了チェックリスト

結果報告前に以下をすべて確認。未達成項目があれば修正してから報告:

- [ ] 前提条件をすべて満たした
- [ ] 自動チェック（テスト、Lint、ビルド）を実行した
- [ ] チェックリストの全項目を確認した
- [ ] 各指摘の行番号が正確（該当コードが存在する）
- [ ] 各指摘に確信度スコアと根拠を記載した
- [ ] 自己検証で重複・過剰指摘を除外した
- [ ] 大規模変更の場合、段階的レビューを提案した
- [ ] 優先度（Critical/High/Medium/Low）が適切
- [ ] 出力形式に従っている

## 原則

- 優先順位を明確に、具体的な修正案と根拠を提示
- 曖昧な指摘、主観の押し付け、Lint自動化可能な指摘は避ける

## 関連

- `/review-update` - レビューの学びをチェックリスト・コマンドに反映
